<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki - Romitagl.com</title>
    <meta name="description"
        content="Personal knowledge wiki containing quotes, resources, and other useful information.">
    <meta name="keywords" content="wiki, quotes, knowledge base, resources">
    <meta name="author" content="romitagl.com">
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="Wiki - Romitagl.com">
    <meta property="og:description"
        content="Personal knowledge wiki containing quotes, resources, and other useful information.">
    <meta property="og:url" content="https://romitagl.com/wiki.html">
    <!-- Canonical URL -->
    <link rel="canonical" href="https://romitagl.com/wiki.html" />
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Link to the external CSS files -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/wiki-styles.css">
    <!-- Component Loader Script -->
    <script src="components.js"></script>
</head>

<body>
    <div class="container">
        <!-- Navigation will be loaded here -->
        <div data-component="navigation"></div>

        <!-- Hero section for Wiki -->
        <section class="hero">
            <div class="hero-content">
                <h1>Knowledge Wiki</h1>
                <p>A collection of valuable information, quotes, and resources organized in a structured way to help you
                    find what you need quickly.</p>
            </div>
            <div class="hero-image">
                <img src="assets/images/wiki.svg" alt="Wiki Knowledge Base"
                    onerror="this.src='https://api.lorem.space/image/abstract?w=500&h=400'">
            </div>
        </section>

        <!-- Wiki Content Section -->
        <section class="wiki-section">
            <div class="wiki-container">
                <div class="wiki-header">
                    <h2>Browse Knowledge Base</h2>
                    <p>Explore different categories of information in the tabs below.</p>
                </div>

                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <ul class="tabs-nav">
                        <li class="tab-item active" data-tab="quotes">Quotes</li>
                        <li class="tab-item" data-tab="resources">Resources</li>
                    </ul>

                    <!-- Tab Content -->
                    <div id="quotes" class="tab-content active">
                        <div class="quotes-container">
                            <div id="quotes-header">
                                <h3>Inspirational and Thought-Provoking Quotes</h3>
                                <p>A collection of quotes from various sources that provide insight, inspiration, and
                                    wisdom.</p>
                                <div class="last-updated" id="quotes-updated">
                                    Loading quotes...
                                    <button id="refresh-quotes" class="refresh-button" style="display: none;">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="quotes-content" class="content-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading quotes...
                            </div>
                        </div>
                    </div>

                    <!-- Resources Tab -->
                    <div id="resources" class="tab-content">
                        <div class="resources-container">
                            <div id="resources-header">
                                <h3>Useful Resources & Links</h3>
                                <p>A curated collection of valuable resources, tools, and references.</p>
                                <div class="last-updated" id="resources-updated">
                                    Loading resources...
                                    <button id="refresh-resources" class="refresh-button" style="display: none;">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="resources-content" class="content-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading resources...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer will be loaded here -->
        <div data-component="footer"></div>
    </div>

    <!-- Wiki Content Functionality Script -->
    <script>
        // Tab initialization
        document.addEventListener("DOMContentLoaded", function () {
            // Global storage for tags and categories
            window.wikiData = {
                currentTab: 'quotes',
                tags: new Set(),
                categories: new Set()
            };

            // Initialize tab functionality
            initTabs();

            // Load the active tab
            loadActiveTab();
        });

        // Function to initialize tabs
        function initTabs() {
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');

            tabItems.forEach(item => {
                item.addEventListener('click', function () {
                    // Remove active class from all tabs and contents
                    tabItems.forEach(tab => tab.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Show corresponding content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');

                    // Update current tab in wikiData
                    window.wikiData.currentTab = tabId;

                    // Reset tags and categories when switching tabs
                    window.wikiData.tags = new Set();
                    window.wikiData.categories = new Set();

                    // Load the tab content
                    loadWikiContent(tabId);
                });
            });
        }

        // Load the active tab
        function loadActiveTab() {
            const activeTab = document.querySelector('.tab-item.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                window.wikiData.currentTab = tabId;
                loadWikiContent(tabId);
            } else {
                // Default to quotes if no tab is active
                document.querySelector('[data-tab="quotes"]').classList.add('active');
                document.getElementById('quotes').classList.add('active');
                window.wikiData.currentTab = 'quotes';
                loadWikiContent('quotes');
            }
        }

        // Function to load wiki content
        function loadWikiContent(contentType) {
            const contentElement = document.getElementById(`${contentType}-content`);
            const updatedElement = document.getElementById(`${contentType}-updated`);
            const refreshButton = document.getElementById(`refresh-${contentType}`);

            contentElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading ${contentType}...`;

            // Show the refresh button
            if (refreshButton) {
                refreshButton.style.display = 'inline-flex';
            }

            // Storage key names
            const storageKeyContent = `${contentType}Content`;
            const storageKeyTimestamp = `${contentType}Timestamp`;

            // Function to format date
            function formatDate(timestamp) {
                const date = new Date(parseInt(timestamp));
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Check cache first
            const cachedContent = localStorage.getItem(storageKeyContent);
            const cachedTimestamp = localStorage.getItem(storageKeyTimestamp);

            if (cachedContent && cachedTimestamp && (Date.now() - cachedTimestamp < 24 * 60 * 60 * 1000)) {
                // Use cached content
                try {
                    // Process the cached markdown content
                    processMarkdownContent(cachedContent, contentType, contentElement);

                    // Update timestamp display
                    updatedElement.innerHTML = 'Last updated: ' + formatDate(cachedTimestamp) +
                        ` <button id="refresh-${contentType}" class="refresh-button">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>`;

                    // Add event listener to refresh button
                    document.getElementById(`refresh-${contentType}`).addEventListener('click', function () {
                        fetchMarkdown(contentType);
                    });
                } catch (error) {
                    console.error(`Error parsing cached content: ${error}`);
                    // Fetch fresh content on error
                    fetchMarkdown(contentType);
                }
            } else {
                // Fetch fresh content
                fetchMarkdown(contentType);
            }

            // Function to fetch markdown from GitHub
            function fetchMarkdown(contentType) {
                // GitHub wiki URL - capitalize first letter of content type for correct file name
                const githubWikiUrl = `https://raw.githubusercontent.com/wiki/romitagl/www/${contentType.charAt(0).toUpperCase() + contentType.slice(1)}.md`;

                fetch(githubWikiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(markdown => {
                        try {
                            // Process the markdown content
                            processMarkdownContent(markdown, contentType, contentElement);

                            // Cache the content
                            localStorage.setItem(storageKeyContent, markdown);
                            const now = Date.now();
                            localStorage.setItem(storageKeyTimestamp, now);

                            // Update timestamp
                            updatedElement.innerHTML = 'Last updated: ' + formatDate(now) +
                                ` <button id="refresh-${contentType}" class="refresh-button">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>`;

                            // Add event listener to refresh button
                            document.getElementById(`refresh-${contentType}`).addEventListener('click', function () {
                                fetchMarkdown(contentType);
                            });
                        } catch (error) {
                            console.error(`Error processing markdown: ${error}`);
                            contentElement.innerHTML = `<p>Error parsing content. Please try again later.</p>`;
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching markdown: ${error}`);

                        // Try to use cached content as fallback
                        if (cachedContent) {
                            processMarkdownContent(cachedContent, contentType, contentElement);
                            updatedElement.innerHTML = 'Last updated: ' + formatDate(cachedTimestamp) +
                                ' <span style="color: #e74c3c;">(Offline mode)</span>' +
                                ` <button id="refresh-${contentType}" class="refresh-button">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>`;

                            // Add event listener to refresh button
                            document.getElementById(`refresh-${contentType}`).addEventListener('click', function () {
                                fetchMarkdown(contentType);
                            });
                        } else {
                            contentElement.innerHTML = `<p>Failed to load content. Please check your connection.</p>`;
                        }
                    });
            }
        }

        // Process markdown content
        function processMarkdownContent(markdown, contentType, contentElement) {
            // Parse the markdown into sections
            const sections = parseMarkdownToSections(markdown);

            // Reset tags and categories for this content type
            window.wikiData.tags = new Set();
            window.wikiData.categories = new Set();

            // Create HTML for sections
            let contentHtml = '';

            sections.forEach((section, index) => {
                // Add section title to categories
                if (section.title) {
                    window.wikiData.categories.add(section.title);
                }

                // Extract tags from content
                extractTags(section.content);

                // Format content with proper HTML and image handling
                const formattedContent = formatContentWithImagesAndTags(section.content);

                // Create collapsible section
                const isFirstSection = index === 0;
                contentHtml += `
                <div class="content-section">
                    <div class="section-header" data-section="${index}">
                        <h3>
                            <span class="category-icon">${section.title ? section.title.charAt(0) : 'X'}</span>
                            ${section.title || 'Uncategorized'}
                        </h3>
                        <button class="toggle-section"><i class="fas fa-chevron-${isFirstSection ? 'up' : 'down'}"></i></button>
                    </div>
                    <div class="section-content ${isFirstSection ? 'expanded' : ''}" id="section-${contentType}-${index}">
                        <div class="content-block">
                            ${formattedContent}
                        </div>
                    </div>
                </div>`;
            });

            // Update content element
            contentElement.innerHTML = contentHtml || `<p>No ${contentType} content available.</p>`;

            // Initialize section toggles after content is loaded
            initSectionToggles();
        }

        // Parse markdown into sections based on ## headings
        function parseMarkdownToSections(markdown) {
            const sections = [];
            let currentSectionTitle = '';
            let currentSectionContent = '';
            let inFirstSection = true;

            const lines = markdown.split('\n');

            // Process line by line
            lines.forEach(line => {
                // Check for section headings (## heading)
                if (line.startsWith('## ')) {
                    // If we have content already, push it as a section
                    if (inFirstSection) {
                        inFirstSection = false;
                    } else if (currentSectionContent.trim()) {
                        sections.push({
                            title: currentSectionTitle || 'Uncategorized',
                            content: currentSectionContent.trim()
                        });
                    }

                    // Start a new section
                    currentSectionTitle = line.substring(3).trim();
                    currentSectionContent = '';
                } else {
                    // Add to current section content
                    currentSectionContent += line + '\n';
                }
            });

            // Add the last section
            if (currentSectionContent.trim()) {
                sections.push({
                    title: currentSectionTitle || 'Uncategorized',
                    content: currentSectionContent.trim()
                });
            }

            return sections;
        }

        // Extract tags from content and add to global tags set
        function extractTags(content) {
            const tagRegex = /#([a-zA-Z0-9]+)/g;
            let match;
            while ((match = tagRegex.exec(content)) !== null) {
                if (match[1]) {
                    window.wikiData.tags.add(match[1].toLowerCase());
                }
            }
        }

        // Function to format content with proper HTML, handling images and tags
        function formatContentWithImagesAndTags(content) {
            // Handle GitHub hosted images first
            content = content.replace(/!\[([^\]]*)\]\((https:\/\/github\.com\/[^)]+)\)(\s+#[a-zA-Z0-9\s#]+)?/g,
                '<img src="$2" alt="$1" class="wiki-image">$3');

            // Handle subsection headers (###)
            content = content.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');

            // Format lists
            content = content.replace(/^\*\s+(.+)$/gm, '<li>$1</li>');
            content = content.replace(/^-\s+(.+)$/gm, '<li>$1</li>');

            // Group list items
            content = content.replace(/(<li>.*<\/li>[\n\r]*)+/g, function (match) {
                return '<ul>' + match + '</ul>';
            });

            // Format sublists (indented by spaces or tab)
            content = content.replace(/^(\s{2,4}|\t)-\s+(.+)$/gm, '<li class="sublist">$2</li>');

            // Format blockquotes
            content = content.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');

            // Format links
            content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

            // Format inline code
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Format bold text
            content = content.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Format italic text
            content = content.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Convert hashtags to styled tags
            content = content.replace(/#([a-zA-Z0-9]+)/g, '<a href="javascript:void(0)" class="content-tag" data-tag="$1">#$1</a>');

            // Convert paragraphs (empty lines)
            content = content.replace(/\n\n/g, '</p><p>');

            // Wrap with paragraph tags if not already wrapped
            if (!content.startsWith('<p>')) {
                content = '<p>' + content + '</p>';
            }

            // Fix any doubled paragraph tags
            content = content.replace(/<\/p><p><\/p><p>/g, '</p><p>');

            return content;
        }

        // Initialize section toggle functionality
        function initSectionToggles() {
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', function (e) {
                    // Skip if toggle button was clicked directly (it has its own handler)
                    if (e.target.closest('.toggle-section')) {
                        return;
                    }

                    toggleSection(this);
                });

                // Add toggle button handler
                const toggleButton = header.querySelector('.toggle-section');
                if (toggleButton) {
                    toggleButton.addEventListener('click', function (e) {
                        e.stopPropagation(); // Prevent triggering parent click event
                        toggleSection(header);
                    });
                }
            });

            // Add click handlers to content tags
            document.querySelectorAll('.content-tag').forEach(tag => {
                tag.addEventListener('click', function () {
                    const tagName = this.getAttribute('data-tag');
                    console.log('Tag clicked:', tagName);
                    // Here you would implement your tag filtering functionality
                });
            });
        }

        // Toggle section expanded/collapsed state
        function toggleSection(header) {
            const sectionId = header.getAttribute('data-section');
            const tabId = window.wikiData.currentTab;
            const contentDiv = document.getElementById(`section-${tabId}-${sectionId}`);
            const toggleIcon = header.querySelector('.toggle-section i');

            if (contentDiv) {
                contentDiv.classList.toggle('expanded');

                if (contentDiv.classList.contains('expanded')) {
                    toggleIcon.className = 'fas fa-chevron-up';
                } else {
                    toggleIcon.className = 'fas fa-chevron-down';
                }
            }
        }
    </script>
</body>

</html>